<?php
/**
 * Created by BengBengFramework.
 * User: hahastein
 * Date: 2018-09-10
 * Time: 18:06
 */

namespace bengbeng\framework\widgets\menu;

use bengbeng\framework\base\Enum;
use bengbeng\framework\models\platform\MenuARModel;
use Yii;
use yii\base\Widget;
use yii\db\ActiveQuery;

/**
 * Class StrongMenu
 * @package bengbeng\framework\widgets\menu
 */
class StrongMenu extends Widget
{

    const TYPE_DEFAULT = 0;
    const TYPE_LEFT = 10;
    const TYPE_TOP = 20;
    const TYPE_RIGHT = 30;

    public $type = self::TYPE_DEFAULT;
    public $menuCate;
    public $layout;
    public $cache = true;

    private $menuData;

    public function init()
    {
        parent::init(); // TODO: Change the autogenerated stub
        $this->menuData = false;
        self::initData();
    }

    private function initData(){

        $cacheName = Enum::CACHE_MENU_DATA;
        if($this->menuCate){
            $cacheName .= '_'.$this->menuCate;
        }
        $cache = Yii::$app->cache;

        //设置缓存
        if($this->cache){
            $this->menuData = $cache->get($cacheName);
        }else{
            if($cache->exists($cacheName)) {
                $cache->delete($cacheName);
            }
        }

        if ($this->menuData === false){
            $menuModel = new MenuARModel();
            $menuModel->showPage = false;
            $cache_data = $menuModel->dataSet(function (ActiveQuery $query){
                $query->select(['menu_id', 'menu_name', 'menu_icon', 'module', 'controller', 'action', 'parent_id', 'order', 'initials', 'is_home']);
                $query->where(['menu_type' => $this->type]);
                if(isset($this->menuCate)){
                    $query->andWhere(['menu_cate' => $this->menuCate]);
                }
                $query->orderBy([
                    'parent_id' => SORT_ASC,
                    'order' => SORT_ASC
                ]);
                $query->asArray();
            });

            self::resetMenuData($cache_data);

            if($this->cache) {
                $cache->set($cacheName, $this->menuData);
            }
        }
    }

    public function run()
    {
        $moduleID = Yii::$app->controller->module->id;
        $controllerID = Yii::$app->controller->id;
        $actionID = Yii::$app->controller->action->id;



        return $this->render(self::createLayoutPath(), [
            'menus' => $this->menuData,
            'controllerID' => $controllerID,
            'actionID' => $actionID,
            'moduleID' => $moduleID
        ]);
    }

    private function createLayoutPath(){
        if(empty($this->layout)){
            return 'menu-'.self::changeType($this->type);
        }else{
            return $this->layout;
        }
    }

    /**
     * 重置菜单数据
     * @param $menuData
     */
    private function resetMenuData($menuData){
        $this->menuData = [];

        foreach ($menuData as $menu){
            if($menu['parent_id'] == 0){
                $menu['child'] = [];
                $this->menuData[$menu['menu_id']] = $menu;
            }else{
                $this->menuData[$menu['parent_id']]['parent'][] = $menu;
                //将本身赋予父级
                if(!in_array($menu['controller'], $this->menuData[$menu['parent_id']]['child'])){
                    $this->menuData[$menu['parent_id']]['child'][] = $menu['controller'];
                }
            }
        }
    }

    public static function changeType($type){
        switch ($type){
            case self::TYPE_LEFT:
                return 'left';
            case self::TYPE_RIGHT:
                return 'right';
            case self::TYPE_TOP:
                return 'top';
            default:
                return 'layout';
        }
    }
}